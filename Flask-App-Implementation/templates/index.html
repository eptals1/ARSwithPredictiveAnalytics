<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Automated Resume Screening with Predictive Analytics</title>
        <link href="./static/css/bootstrap-5.3.0.css" rel="stylesheet" />
        <link href="./static/css/font-awesome.css" rel="stylesheet" />
        <link href="./static/css/custom-style.css" rel="stylesheet" />
    </head>

    <body class="bg-light">
        <div class="container-fluid py-2">
            <!--h2 class="text-center"><h2-->

            <div class="row">
                <!-- Left Section - Upload and Requirements -->
                <div class="col-md-6 pe-md-2">
                    <div class="card shadow-sm">
                        <div class="card-body">
                            <h5 class="card-title mb-2">
                                <i class="fas fa-file-alt me-2"></i>
                                Upload Resumes
                            </h5>
                            <div
                                class="custom-file-upload p-2"
                                id="resumeUpload"
                            >
                                <i
                                    class="fas fa-cloud-upload-alt fa-2x mb-1"
                                ></i>
                                <p class="mb-0">Drag & Drop Resumes Here</p>
                                <p class="text-muted small">
                                    or click to browse (.pdf, .doc, .docx)
                                </p>
                                <input
                                    type="file"
                                    id="resumeInput"
                                    multiple
                                    accept=".pdf,.doc,.docx"
                                    class="d-none"
                                />
                            </div>
                            <div
                                id="uploadedResumeCount"
                                class="mb-2 text-muted"
                            >
                                No. of Resumes uploaded:
                            </div>
                            <div
                                class="resume-list p-2"
                                id="uploadedResumes"
                                style="
                                    height: 70px;
                                    border: 2px dashed#f7e8d2c8;
                                "
                            >
                                <span class="text-muted text-center" id="resumePlaceholder">
                                    Uploaded resumes will appear here...
                                </span>
                            </div>

                            <!-- Job Requirements Section -->
                            <h5 class="card-title mb-2 mt-2">
                                <i class="fas fa-briefcase me-1"></i>
                                Upload Job Requirement
                            </h5>
                            <div
                                class="custom-file-upload"
                                id="jobRequirementUpload"
                            >
                                <i
                                    class="fas fa-cloud-upload-alt fa-2x mb-1"
                                ></i>
                                <p class="mb-0">
                                    Drag & Drop Job Requirement Here
                                </p>
                                <p class="text-muted small">
                                    or click to browse (.pdf, .doc, .docx)
                                </p>
                                <input
                                    type="file"
                                    id="jobInput"
                                    accept=".pdf,.doc,.docx"
                                    class="d-none"
                                />
                            </div>
                            <div
                                class="resume-list p-2"
                                id="uploadedJob"
                                style="
                                    height: 70px;
                                    border: 2px dashed#f7e8d2c8;
                                "
                            >
                                <span
                                    id="uploadedJobFile"
                                    class="text-muted text-center"
                                >
                                    Uploaded job requirement will appear here...
                                </span>
                            </div>

                            <div class="mt-2">
                                <button
                                    type="button"
                                    id="scoringButton"
                                    class="btn btn-primary w-100"
                                >
                                    <i class="fas fa-chart-line me-2"></i>
                                    Analyze Resumes
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Middle Section - Results -->
                <div class="col-md-6 ps-md-2 mt-4 mt-md-0">
                    <div class="card shadow-sm" style="min-height: 580px">
                        <div class="card-body">
                            <h4 class="card-title mb-4">
                                <i class="fas fa-chart-line me-2"></i>
                                Resume Analysis
                            </h4>
                            <div id="analysisProgress" class="d-none">
                                <div class="progress mb-3">
                                    <div
                                        class="progress-bar progress-bar-striped progress-bar-animated"
                                        role="progressbar"
                                        style="width: 100%"
                                    ></div>
                                </div>
                                <p class="text-center text-muted">
                                    Analyzing resumes...
                                </p>
                            </div>

                            <div id="resultsDiv" style="height: 450px">
                                <!-- Results will be populated here -->
                                <div class="text-center text-muted py-5" id="resultsPlaceholder">
                                    <i
                                        class="fas fa-rectangle-list fa-3x mb-3"
                                    ></i>
                                    <p >
                                        Upload resumes and set job requirement
                                        to see candidate suitability analysis
                                    </p>
                                </div>
                            </div>

                            
                            <div
                                id="scoringResults"
                                style="display: none; max-height: 450px"
                            ></div>
                        </div>
                    </div>
                </div>

        <script src="./static/js/jquery-3.6.0.js"></script>
        <script src="./static/js/bootstrap-5.3.0.bundle.min.js"></script>
        <script>
            document.addEventListener("DOMContentLoaded", function () {
                function handleFileUpload(
                    inputElement,
                    displayElement,
                    countElement
                ) {
                    inputElement.addEventListener("change", function (event) {
                        const files = event.target.files;
                        updateFileDisplay(files, displayElement, countElement);
                    });
                }

                function handleDragDrop(
                    dropArea,
                    inputElement,
                    displayElement,
                    countElement
                ) {
                    dropArea.addEventListener("dragover", function (event) {
                        event.preventDefault();
                        dropArea.classList.add("drag-over");
                    });

                    dropArea.addEventListener("dragleave", function () {
                        dropArea.classList.remove("drag-over");
                    });

                    dropArea.addEventListener("drop", function (event) {
                        event.preventDefault();
                        dropArea.classList.remove("drag-over");

                        const files = event.dataTransfer.files;
                        if (inputElement.files.length > 0) {
                            return; // Prevent overwriting existing file selections
                        }

                        const dataTransfer = new DataTransfer();
                        for (let file of files) {
                            dataTransfer.items.add(file);
                        }
                        inputElement.files = dataTransfer.files;
                        inputElement.dispatchEvent(new Event("change")); // Ensure UI updates
                    });
                }

                function updateFileDisplay(
                    files,
                    displayElement,
                    countElement
                ) {
                    displayElement.innerHTML = "";
                    if (files.length === 0) {
                        displayElement.innerHTML =
                            "<span class='text-muted'>No files uploaded</span>";
                        if (countElement)
                            countElement.textContent =
                                "No. of Resumes uploaded: 0";
                        return;
                    }

                    if (countElement)
                        countElement.textContent = `No. of Resumes uploaded: ${files.length}`;
                    for (let file of files) {
                        let fileItem = document.createElement("p");
                        fileItem.textContent = file.name;
                        fileItem.classList.add("small", "text-muted");
                        displayElement.appendChild(fileItem);
                    }
                }

                const resumeInput = document.getElementById("resumeInput");
                const resumeUpload = document.getElementById("resumeUpload");
                const uploadedResumes =
                    document.getElementById("uploadedResumes");
                const uploadedResumeCount = document.getElementById(
                    "uploadedResumeCount"
                );

                const jobInput = document.getElementById("jobInput");
                const jobRequirementUpload = document.getElementById(
                    "jobRequirementUpload"
                );
                const uploadedJobFile =
                    document.getElementById("uploadedJobFile");

                const scoringButton = document.getElementById("scoringButton");
                // const analyzeButton = document.getElementById("analyzeButton");
                const endAnalysisButton =
                    document.getElementById("endAnalysisButton");

                // Add drag and drop handlers for both zones
                [resumeDropZone, jobDropZone].forEach((dropZone) => {
                    ["dragenter", "dragover", "dragleave", "drop"].forEach(
                        (eventName) => {
                            dropZone.addEventListener(
                                eventName,
                                preventDefaults,
                                false
                            );
                        }
                    );

                    ["dragenter", "dragover"].forEach((eventName) => {
                        dropZone.addEventListener(
                            eventName,
                            () => highlight(dropZone),
                            false
                        );
                    });

                    ["dragleave", "drop"].forEach((eventName) => {
                        dropZone.addEventListener(
                            eventName,
                            () => unhighlight(dropZone),
                            false
                        );
                    });
                });

                function preventDefaults(e) {
                    e.preventDefault();
                    e.stopPropagation();
                }

                function highlight(element) {
                    element.classList.add("border-primary");
                }

                function unhighlight(element) {
                    element.classList.remove("border-primary");
                }

                // Resume upload handlers
                resumeDropZone.addEventListener(
                    "drop",
                    handleResumeDrop,
                    false
                );
                resumeDropZone.addEventListener("click", () =>
                    resumeInput.click()
                );
                resumeInput.addEventListener("change", handleResumeFiles);

                // Job requirements upload handlers
                jobDropZone.addEventListener("drop", handleJobDrop, false);
                jobDropZone.addEventListener("click", () => jobInput.click());
                jobInput.addEventListener("change", handleJobFiles);

                function handleResumeDrop(e) {
                    const dt = e.dataTransfer;
                    const files = dt.files;
                    handleResumeFiles({
                        target: {
                            files: files,
                        },
                    });
                }

                function handleJobDrop(e) {
                    const dt = e.dataTransfer;
                    const files = dt.files;
                    handleJobFiles({
                        target: {
                            files: files,
                        },
                    });
                }

                function handleResumeFiles(e) {
                    const files = [...e.target.files];
                    files.forEach((file) => {
                        const div = document.createElement("div");
                        div.className =
                            "resume-item d-flex justify-content-between align-items-center";
                        div.innerHTML = `
                                        <div>
                                            <i class="fas fa-file-pdf me-2"></i>
                                            ${file.name}
                                        </div>
                                        <button class="btn btn-sm btn-outline-danger" onclick="this.parentElement.remove()">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    `;
                        uploadedResumes.appendChild(div);
                        resumePlaceholder.style.display = "none";
                        uploadedResumeCount.innerHTML = `No. of Uploaded resumes: ${uploadedResumes.children.length - 1}`;
                    });
                }

                function handleJobFiles(e) {
                    const files = [...e.target.files];
                    if (files.length > 0) {
                        // Only show the last uploaded file
                        uploadedJob.innerHTML = "";
                        const file = files[0];
                        const div = document.createElement("div");
                        div.className =
                            "resume-item d-flex justify-content-between align-items-center";
                        div.innerHTML = `
                                <div>
                                    <i class="fas fa-file-pdf me-2"></i>
                                    ${file.name}
                                </div>
                                <button class="btn btn-sm btn-outline-danger" onclick="this.parentElement.remove()">
                                    <i class="fas fa-times"></i>
                                </button>
                            `;
                        uploadedJob.appendChild(div);
                    }
                }

                // Handle scoring button click
                scoringButton.addEventListener("click", function () {
                    if (!jobInput.files.length || !resumeInput.files.length) {
                        alert(
                            "Please upload resumes and a job description first."
                        );
                        return;
                    }
                    scoringButton.disabled = true;
                    scoringButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Scoring';
                    resultsDiv = document.getElementById("resultsDiv");
                    resultsDiv.innerHTML = "";
                    $("#analysisProgress").removeClass("d-none");
                    // $("#analyzeButton").hide();
                    // $("#endAnalysisButton").show();
                    // analyzeButton.disabled = true;

                    let formData = new FormData();
                    formData.append("job_description", jobInput.files[0]); // Send actual job file
                    for (let file of resumeInput.files) {
                        formData.append("resumes", file); // Send actual resumes
                    }

                    fetch("/score-resumes", {
                        method: "POST",
                        body: formData,
                    })
                        .then((response) => response.json())
                        .then((data) => {
                            if (data.success) {
                                console.log("API Response:", data);
                                // Extract resumes safely
                                let resumes = data.data.resumes || [];
                                let resultsContainer =
                                    document.getElementById("resultsDiv");
                                resultsContainer.innerHTML = `
                                    <div class="card shadow-sm mb-3">
                                        <div class="card-body" style="overflow: auto; max-height: 450px; min-height: 450px;">
                                            ${
                                                resumes.length > 0
                                                    ? resumes
                                                          .map(
                                                              (resume) => `
                                                    <div class="resume-match mb-3">
                                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                                            <h6 class="mb-0">${
                                                                resume.filename
                                                            }</h6>
                                                            <p><b>${(
                                                                resume.similarity *
                                                                100
                                                            ).toFixed(
                                                                2
                                                            )}%</b> relevant </p>
                                                        </div>
                                                        <p>ðŸ“Œ Suitable Analysis: not suitable, less-suitable, mildly suitable, highly-suitable 
                                                        </p>
                                                        <div class="progress">
                                                            <div class="progress-bar" role="progressbar"
                                                                style="width: ${(
                                                                    resume.similarity *
                                                                    100
                                                                ).toFixed(2)}%"
                                                                aria-valuemin="0"
                                                                aria-valuemax="100">
                                                                ${(
                                                                    resume.similarity *
                                                                    100
                                                                ).toFixed(2)}%
                                                            </div>
                                                        </div>
                                                    </div>
                                                    `
                                                          )
                                                          .join("")
                                                    : "<p>No resumes found</p>"
                                            }
                                        </div>
                                    </div>
                                `;
                                $("#analysisProgress").addClass("d-none");
                            } else {
                                alert("Error: " + data.message);
                            }
                        })
                        .catch((error) =>
                            console.error("Error fetching data:", error)
                        );
                });
            });
        </script>
    </body>
</html>

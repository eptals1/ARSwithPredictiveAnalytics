<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Automated Resume Screening with Predictive Analytics</title>
        <link href="/static/css/bootstrap-5.3.0.css" rel="stylesheet" />
        <link href="/static/css/font-awesome.css" rel="stylesheet" />
        <link href="/static/css/custom-style.css" rel="stylesheet" />
    </head>

    <body class="bg-light">
        <div class="container-fluid py-2">
            <!--h2 class="text-center"><h2-->

            <div class="row">
                <!-- Left Section - Upload and Requirements -->
                <div class="col-md-6 pe-md-2">
                    <div class="card shadow-sm">
                        <div class="card-body">
                            <h5 class="card-title mb-2">
                                <i class="fas fa-file-alt me-2"></i>
                                Upload Resumes
                            </h5>
                            <div
                                class="custom-file-upload p-2"
                                id="resumeUpload"
                            >
                                <i
                                    class="fas fa-cloud-upload-alt fa-2x mb-1"
                                ></i>
                                <p class="mb-0">Drag & Drop Resumes Here</p>
                                <p class="text-muted small">
                                    or click to browse (.pdf, .doc, .docx)
                                </p>
                                <input
                                    type="file"
                                    id="resumeInput"
                                    multiple
                                    accept=".pdf,.doc,.docx"
                                    class="d-none"
                                />
                            </div>
                            <div
                                id="uploadedResumeCount"
                                class="mb-2 text-muted"
                            >
                                No. of Resumes uploaded:
                            </div>
                            <div
                                class="resume-list p-2"
                                id="uploadedResumes"
                                style="
                                    height: 70px;
                                    border: 2px dashed#f7e8d2c8;
                                "
                            >
                                <span class="text-muted text-center">
                                    Uploaded resumes will appear here...
                                </span>
                            </div>

                            <!-- Job Requirements Section -->
                            <h5 class="card-title mb-2 mt-2">
                                <i class="fas fa-briefcase me-1"></i>
                                Upload Job Requirement
                            </h5>
                            <div
                                class="custom-file-upload"
                                id="jobRequirementUpload"
                            >
                                <i
                                    class="fas fa-cloud-upload-alt fa-2x mb-1"
                                ></i>
                                <p class="mb-0">
                                    Drag & Drop Job Requirement Here
                                </p>
                                <p class="text-muted small">
                                    or click to browse (.pdf, .doc, .docx)
                                </p>
                                <input
                                    type="file"
                                    id="jobInput"
                                    accept=".pdf,.doc,.docx"
                                    class="d-none"
                                />
                            </div>
                            <div
                                class="resume-list p-2"
                                id="uploadedJob"
                                style="
                                    height: 70px;
                                    border: 2px dashed#f7e8d2c8;
                                "
                            >
                                <span
                                    id="uploadedJobFile"
                                    class="text-muted text-center"
                                >
                                    Uploaded job requirement will appear here...
                                </span>
                            </div>

                            <div class="mt-2">
                                <button
                                    type="button"
                                    id="scoringButton"
                                    class="btn btn-primary w-100"
                                >
                                    <i class="fas fa-chart-bar me-2"></i>
                                    Analyze Resumes
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Section - Results -->
                <div class="col-md-6 ps-md-2 mt-4 mt-md-0">
                    <div class="card shadow-sm" style="min-height: 580px">
                        <div class="card-body">
                            <h4 class="card-title mb-4">
                                <i class="fas fa-chart-bar me-2"></i>
                                Resume Analysis Results
                            </h4>
                            <div id="analysisProgress" class="d-none">
                                <div class="progress mb-3">
                                    <div
                                        class="progress-bar progress-bar-striped progress-bar-animated"
                                        role="progressbar"
                                        style="width: 100%"
                                    ></div>
                                </div>
                                <p class="text-center text-muted">
                                    Analyzing resumes...
                                </p>
                            </div>

                            <div id="scoringResults" style="height: 450px">
                                <!-- Results will be populated here -->
                                <div class="text-center text-muted py-5">
                                    <i class="fas fa-chart-bar fa-3x mb-3"></i>
                                    <p>
                                        Upload resumes and set job requirement
                                        to see analysis of resumes
                                    </p>
                                </div>
                            </div>
                            <div
                                id="scoringResults"
                                style="
                                    display: none;
                                    overflow-y: scroll;
                                    max-height: 450px;
                                "
                            ></div>
                            <!-- <div class="mt-2">
                                <button
                                    type="button"
                                    id="analyzeButton"
                                    class="btn btn-success w-100"
                                >
                                    <i class="fas fa-chart-bar me-2"></i>
                                    
                                </button>
                            </div> -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script src="/static/js/jquery-3.6.0.js"></script>
        <script src="/static/js/bootstrap-5.3.0.bundle.min.js"></script>
        <script>
            document.addEventListener("DOMContentLoaded", function () {
                function handleFileUpload(
                    inputElement,
                    displayElement,
                    countElement
                ) {
                    inputElement.addEventListener("change", function (event) {
                        const files = event.target.files;
                        updateFileDisplay(files, displayElement, countElement);
                    });
                }

                function handleDragDrop(
                    dropArea,
                    inputElement,
                    displayElement,
                    countElement
                ) {
                    dropArea.addEventListener("dragover", function (event) {
                        event.preventDefault();
                        dropArea.classList.add("drag-over");
                    });

                    dropArea.addEventListener("dragleave", function () {
                        dropArea.classList.remove("drag-over");
                    });

                    dropArea.addEventListener("drop", function (event) {
                        event.preventDefault();
                        dropArea.classList.remove("drag-over");

                        const files = event.dataTransfer.files;
                        if (inputElement.files.length > 0) {
                            return; // Prevent overwriting existing file selections
                        }

                        const dataTransfer = new DataTransfer();
                        for (let file of files) {
                            dataTransfer.items.add(file);
                        }
                        inputElement.files = dataTransfer.files;
                        inputElement.dispatchEvent(new Event("change")); // Ensure UI updates
                    });
                }

                function updateFileDisplay(
                    files,
                    displayElement,
                    countElement
                ) {
                    displayElement.innerHTML = "";
                    if (files.length === 0) {
                        displayElement.innerHTML =
                            "<span class='text-muted'>No files uploaded</span>";
                        if (countElement)
                            countElement.textContent =
                                "No. of Resumes uploaded: 0";
                        return;
                    }

                    if (countElement)
                        countElement.textContent = `No. of Resumes uploaded: ${files.length}`;
                    for (let file of files) {
                        let fileItem = document.createElement("p");
                        fileItem.textContent = file.name;
                        fileItem.classList.add("small", "text-muted");
                        displayElement.appendChild(fileItem);
                    }
                }

                const resumeInput = document.getElementById("resumeInput");
                const resumeUpload = document.getElementById("resumeUpload");
                const uploadedResumes =
                    document.getElementById("uploadedResumes");
                const uploadedResumeCount = document.getElementById(
                    "uploadedResumeCount"
                );

                const jobInput = document.getElementById("jobInput");
                const jobRequirementUpload = document.getElementById(
                    "jobRequirementUpload"
                );
                const uploadedJobFile =
                    document.getElementById("uploadedJobFile");

                handleFileUpload(
                    resumeInput,
                    uploadedResumes,
                    uploadedResumeCount
                );
                handleDragDrop(
                    resumeUpload,
                    resumeInput,
                    uploadedResumes,
                    uploadedResumeCount
                );

                handleFileUpload(jobInput, uploadedJobFile, null); // No count for job file
                handleDragDrop(
                    jobRequirementUpload,
                    jobInput,
                    uploadedJobFile,
                    null
                );

                resumeUpload.addEventListener("click", function () {
                    resumeInput.click();
                });

                jobRequirementUpload.addEventListener("click", function () {
                    jobInput.click();
                });
            });

            document.addEventListener("DOMContentLoaded", function () {
                const scoringButton = document.getElementById("scoringButton");
                const analyzeButton = document.getElementById("analyzeButton");
                const resumeInput = document.getElementById("resumeInput");
                const jobInput = document.getElementById("jobInput");
                const scoringResults =
                    document.getElementById("scoringResults");
                const analysisResults =
                    document.getElementById("analysisResults");
                const analysisProgress = $("#analysisProgress");

                scoringButton.addEventListener("click", function () {
                    if (!jobInput.files.length || !resumeInput.files.length) {
                        alert(
                            "Please upload resumes and a job description first."
                        );
                        return;
                    }
                    scoringButton.disabled = true;
                    analysisProgress.removeClass("d-none");
                    scoringButton.innerHTML =
                        '<i class="fas fa-spinner fa-spin me-2"></i>Scoring';
                    scoringResults.innerHTML = ""; // Clear previous results

                    let formData = new FormData();
                    formData.append("job_description", jobInput.files[0]); // Send actual job file
                    for (let file of resumeInput.files) {
                        formData.append("resumes", file); // Send actual resumes
                    }

                    fetch("/score-resumes", {
                        method: "POST",
                        body: formData,
                    })
                        .then((response) => response.json())
                        .then((data) => {
                            if (!data || !data.scores) {
                                alert("Error: No scores received.");
                                return;
                            }
                            scoringButton.innerHTML =
                                '<i class="fas fa-chart-bar me-2"></i> Analyze Resumes';
                            analysisProgress.addClass("d-none");
                            const resumes = data.scores;
                            const resultsDiv =
                                document.getElementById("scoringResults");
                            resultsDiv.innerHTML = `
                        <div class="card shadow-sm mb-3">
                            <div class="card-body" style="overflow: auto; max-height: 450px; min-height: 450px;">
                                ${resumes
                                    .map(
                                        (resume) => `
                                        <div class="resume-match mb-3">
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <h6 class="mb-0">${
                                                    resume.resume
                                                }</h6>
                                                <span class="badge ${
                                                    resume.classification ===
                                                    "Suitable"
                                                        ? "bg-success"
                                                        : "bg-danger"
                                                }">${
                                            resume.classification
                                        }</span>
                                            </div>
                                            <div class="progress">
                                                <div class="progress-bar" role="progressbar"
                                                    style="width: ${(
                                                        resume.score * 100
                                                    ).toFixed(2)}%"
                                                    aria-valuenow="${(
                                                        resume.score * 100
                                                    ).toFixed(2)}"
                                                    aria-valuemin="0"
                                                    aria-valuemax="100">
                                                    ${(
                                                        resume.score * 100
                                                    ).toFixed(2)}%
                                                </div>
                                            </div>
                                        </div>
                                    `
                                    )
                                    .join("")}
                            </div>
                        </div>
                    `;
                            // Show results section
                            resultsDiv.style.display = "block";
                        })
                        .catch((error) => console.error("Error:", error));
                });

                analyzeButton.addEventListener("click", function () {
                    let rejectedResumes = [];
                    for (let file of resumeInput.files) {
                        let scoreElement = document.getElementById(
                            `score-${file.name}`
                        );
                        if (
                            scoreElement &&
                            parseFloat(scoreElement.textContent) < 0.5
                        ) {
                            rejectedResumes.push(file);
                        }
                    }

                    if (rejectedResumes.length === 0) {
                        alert("No rejected resumes to analyze.");
                        return;
                    }

                    let formData = new FormData();
                    rejectedResumes.forEach((file) =>
                        formData.append("rejected_resumes", file)
                    );

                    fetch("/analyze-rejected", {
                        method: "POST",
                        body: formData,
                    })
                        .then((response) => response.json())
                        .then((data) => {
                            displayAnalysis(data);
                        })
                        .catch((error) => console.error("Error:", error));
                });

                function displayScores(scores) {
                    scoringResults.innerHTML = scores.length
                        ? scores
                              .map(
                                  (score) =>
                                      `<div>${score.resume}: <span id='score-${
                                          score.resume
                                      }'>${score.score.toFixed(2)}</span></div>`
                              )
                              .join("")
                        : "<p class='text-muted text-center'>No scores available.</p>";
                }

                function displayAnalysis(analysis) {
                    analysisResults.innerHTML = analysis.length
                        ? analysis
                              .map(
                                  (item) =>
                                      `<div>${item.resume}: Suggested Job - ${item.suggested_job}</div>`
                              )
                              .join("")
                        : "<p class='text-muted text-center'>No job suggestions available.</p>";
                }
            });
        </script>
    </body>
</html>

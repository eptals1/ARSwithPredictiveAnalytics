<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Automated Resume Screening with Predictive Analytics</title>
        <link href="/static/css/bootstrap-5.3.0.css" rel="stylesheet" />
        <link href="/static/css/font-awesome.css" rel="stylesheet" />
        <link href="/static/css/custom-style.css" rel="stylesheet" />
    </head>

    <body class="bg-light">
        <div class="container-fluid py-2">
            <div class="row">
                <!-- Left Section - Upload and Requirements -->
                <div class="col-md-4 pe-md-2">
                    <div class="card shadow-sm">
                        <div class="card-body">
                            <h5 class="card-title mb-2">
                                <i class="fas fa-file-alt me-2"></i>
                                Upload Resumes
                            </h5>
                            <div
                                class="custom-file-upload p-2"
                                id="resumeUpload"
                            >
                                <i
                                    class="fas fa-cloud-upload-alt fa-2x mb-1"
                                ></i>
                                <p class="mb-0">Click here to browse Resumes</p>
                                <p class="text-muted small">
                                    supported files (.pdf, .doc, .docx)
                                </p>
                                <input
                                    type="file"
                                    id="resumeInput"
                                    multiple
                                    accept=".pdf,.doc,.docx"
                                    class="d-none"
                                />
                            </div>
                            <div
                                id="uploadedResumeCount"
                                class="mb-2 text-muted"
                            >
                                No. of Resumes uploaded:
                            </div>
                            <div
                                class="resume-list p-2"
                                id="uploadedResumes"
                                style="
                                    height: 70px;
                                    border: 2px dashed#f7e8d2c8;
                                "
                            >
                                <span
                                    class="text-muted text-center"
                                    id="uploadedResumesPlaceholder"
                                >
                                    Uploaded resumes will appear here...
                                </span>
                            </div>

                            <!-- Job Requirements Section -->
                            <h5 class="card-title mb-2 mt-2">
                                <i class="fas fa-briefcase me-1"></i>
                                Upload Job Requirement
                            </h5>
                            <div
                                class="custom-file-upload"
                                id="jobRequirementUpload"
                            >
                                <i
                                    class="fas fa-cloud-upload-alt fa-2x mb-1"
                                ></i>
                                <p class="mb-0">
                                    Click here to browse Job Requirement
                                </p>
                                <p class="text-muted small">
                                    supported files (.pdf, .doc, .docx)
                                </p>
                                <input
                                    type="file"
                                    id="jobInput"
                                    accept=".pdf,.doc,.docx"
                                    class="d-none"
                                />
                            </div>
                            <div
                                class="resume-list p-2"
                                id="uploadedJobFile"
                                style="
                                    height: 70px;
                                    border: 2px dashed#f7e8d2c8;
                                "
                            >
                                <span
                                    id="uploadedJobPlaceholder"
                                    class="text-muted text-center"
                                >
                                    Uploaded job requirement will appear here...
                                </span>
                            </div>

                            <!-- Rank Resumes Button -->
                            <div class="mt-2">
                                <button
                                    type="button"
                                    id="rankingButton"
                                    class="btn btn-primary w-100"
                                >
                                    <i class="fas fa-chart-bar me-2"></i>
                                    Rank Resumes
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Middle Section - Ranking Results -->
                <div class="col-md-4 ps-md-2 mt-4 mt-md-0">
                    <div class="card shadow-sm" style="min-height: 580px">
                        <div class="card-body">
                            <h4 class="card-title mb-4">
                                <i class="fas fa-chart-bar me-2"></i>
                                Ranking Results
                            </h4>
                            <!-- Ranking Loading Screen Modal -->
                            <div
                                class="modal fade"
                                id="rankingProgressModal"
                                tabindex="-1"
                                aria-labelledby="rankingProgressModalLabel"
                                aria-hidden="true"
                            >
                                <div class="modal-dialog modal-dialog-centered">
                                    <div class="modal-content">
                                        <div class="modal-body text-center">
                                            <div
                                                class="spinner-border text-primary"
                                                role="status"
                                            >
                                                <span class="visually-hidden"
                                                    >Ranking resumes...</span
                                                >
                                            </div>
                                            <p class="mt-3 text-muted">
                                                Ranking resumes... Please wait.
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div id="rankingResultsDiv" style="height: 450px">
                                <!-- Results will be populated here -->
                                <div class="text-center text-muted py-5">
                                    <i class="fas fa-chart-bar fa-3x mb-3"></i>
                                    <p>
                                        Upload resumes and set job requirement
                                        to see analysis of resumes
                                    </p>
                                </div>
                            </div>
                            <div
                                id="rankingResults"
                                style="display: none; max-height: 450px"
                            ></div>
                        </div>
                    </div>
                </div>

                <!-- Right Section - Analysis Results -->
                <div class="col-md-4 ps-md-2 mt-4 mt-md-0">
                    <div class="card shadow-sm" style="min-height: 580px">
                        <div class="card-body">
                            <h4 class="card-title mb-4">
                                <i class="fas fa-chart-bar me-2"></i>
                                Resume Analysis Results
                            </h4>
                            <!-- Analysis Loading Screen Modal -->
                            <div
                                class="modal fade"
                                id="analysisProgressModal"
                                tabindex="-1"
                                aria-labelledby="analysisProgressModalLabel"
                                aria-hidden="true"
                            >
                                <div class="modal-dialog modal-dialog-centered">
                                    <div class="modal-content">
                                        <div class="modal-body text-center">
                                            <div
                                                class="spinner-border text-primary"
                                                role="status"
                                            >
                                                <span class="visually-hidden"
                                                    >Ranking resumes...</span
                                                >
                                            </div>
                                            <p class="mt-3 text-muted">
                                                Ranking resumes... Please wait.
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div id="analysisResultsDiv" style="height: 450px">
                                <!-- Results will be populated here -->
                                <div class="text-center text-muted py-5">
                                    <i class="fas fa-chart-bar fa-3x mb-3"></i>
                                    <p>
                                        Upload resumes and set job requirement
                                        to see analysis of resumes
                                    </p>
                                </div>
                            </div>
                            <div
                                id="analysisResults"
                                style="display: none; max-height: 450px"
                            ></div>
                        </div>
                    </div>
                </div>
                <!--End of Col-->
            </div>
            <!--End of Row-->
        </div>
        <!--End of Container-->
                <!-- Right Section - Analysis Results -->
                <div class="col-md-4 ps-md-2 mt-4 mt-md-0">
                    <div class="card shadow-sm" style="min-height: 580px">
                        <div class="card-body">
                            <h4 class="card-title mb-4">
                                <i class="fas fa-chart-bar me-2"></i>
                                Resume Analysis Results
                            </h4>
                            <!-- Analysis Loading Screen Modal -->
                            <div
                                class="modal fade"
                                id="analysisProgressModal"
                                tabindex="-1"
                                aria-labelledby="analysisProgressModalLabel"
                                aria-hidden="true"
                            >
                                <div class="modal-dialog modal-dialog-centered">
                                    <div class="modal-content">
                                        <div class="modal-body text-center">
                                            <div
                                                class="spinner-border text-primary"
                                                role="status"
                                            >
                                                <span class="visually-hidden"
                                                    >Ranking resumes...</span
                                                >
                                            </div>
                                            <p class="mt-3 text-muted">
                                                Ranking resumes... Please wait.
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div id="analysisResultsDiv" style="height: 450px">
                                <!-- Results will be populated here -->
                                <div class="text-center text-muted py-5">
                                    <i class="fas fa-chart-bar fa-3x mb-3"></i>
                                    <p>
                                        Upload resumes and set job requirement
                                        to see analysis of resumes
                                    </p>
                                </div>
                            </div>
                            <div
                                id="analysisResults"
                                style="display: none; max-height: 450px"
                            ></div>

                            <div class="mt-2">
                                <button
                                    type="button"
                                    id="analysisButton"
                                    class="btn btn-primary w-100"
                                >
                                    <i class="fas fa-chart-bar me-2"></i>
                                    Rank Resumes
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!--End of Row-->
        </div>
        <!--End of Container-->
        <script src="/static/js/jquery-3.6.0.js"></script>
        <script src="/static/js/bootstrap-5.3.0.bundle.min.js"></script>
        <script>
            document.addEventListener("DOMContentLoaded", function () {
                // resume elements
                const resumeInput = document.getElementById("resumeInput");
                const resumeUpload = document.getElementById("resumeUpload");
                const uploadedResumeCount = document.getElementById(
                    "uploadedResumeCount"
                );
                const uploadedResumes =
                    document.getElementById("uploadedResumes");
                const resumeDropZone = document.getElementById("resumeUpload");
                // job elements
                const jobInput = document.getElementById("jobInput");
                const jobRequirementUpload = document.getElementById(
                    "jobRequirementUpload"
                );
                const uploadedJobFile =
                    document.getElementById("uploadedJobFile");
                const jobDropZone = document.getElementById(
                    "jobRequirementUpload"
                );
                //ranking button
                const rankingButton = document.getElementById("rankingButton");
                const rankingResultsContainer = document.getElementById(
                    "rankingResultsContainer"
                );
                document.getElementById("rankingResultsDiv");

                function handleFileUpload(
                    inputElement,
                    displayElement,
                    countElement
                ) {
                    inputElement.addEventListener("change", function (event) {
                        const files = event.target.files;
                        updateFileDisplay(files, displayElement, countElement);
                    });
                }

                function handleDragDrop(
                    dropArea,
                    inputElement,
                    displayElement,
                    countElement
                ) {
                    dropArea.addEventListener("dragover", function (event) {
                        event.preventDefault();
                        dropArea.classList.add("drag-over");
                    });

                    dropArea.addEventListener("dragleave", function () {
                        dropArea.classList.remove("drag-over");
                    });

                    dropArea.addEventListener("drop", function (event) {
                        event.preventDefault();
                        dropArea.classList.remove("drag-over");

                        const files = event.dataTransfer.files;
                        if (inputElement.files.length > 0) {
                            return; // Prevent overwriting existing file selections
                        }

                        const dataTransfer = new DataTransfer();
                        for (let file of files) {
                            dataTransfer.items.add(file);
                        }
                        inputElement.files = dataTransfer.files;
                        inputElement.dispatchEvent(new Event("change")); // Ensure UI updates
                    });
                }

                function updateFileDisplay(
                    files,
                    displayElement,
                    countElement
                ) {
                    displayElement.innerHTML = "";
                    if (files.length === 0) {
                        displayElement.innerHTML =
                            "<span class='text-muted'>No files uploaded</span>";
                        if (countElement)
                            countElement.textContent =
                                "No. of Resumes uploaded: 0";
                        return;
                    }

                    if (countElement)
                        countElement.textContent = `No. of Resumes uploaded: ${files.length}`;
                    for (let file of files) {
                        let fileItem = document.createElement("p");
                        fileItem.textContent = file.name;
                        fileItem.classList.add("small", "text-muted");
                        displayElement.appendChild(fileItem);
                    }
                }

                handleFileUpload(
                    resumeInput,
                    uploadedResumes,
                    uploadedResumeCount
                );
                handleDragDrop(
                    resumeUpload,
                    resumeInput,
                    uploadedResumes,
                    uploadedResumeCount
                );

                handleFileUpload(jobInput, uploadedJobFile, null); // No count for job file
                handleDragDrop(
                    jobRequirementUpload,
                    jobInput,
                    uploadedJobFile,
                    null
                );

                resumeUpload.addEventListener("click", function () {
                    resumeInput.click();
                });

                // Job requirements upload handlers
                jobDropZone.addEventListener("drop", handleJobDrop, false);
                jobDropZone.addEventListener("click", () => jobInput.click());
                jobInput.addEventListener("change", handleJobFiles);

                function handleResumeDrop(e) {
                    const dt = e.dataTransfer;
                    const files = dt.files;
                    handleResumeFiles({
                        target: {
                            files: files,
                        },
                    });
                }

                function handleJobDrop(e) {
                    const dt = e.dataTransfer;
                    const files = dt.files;
                    handleJobFiles({
                        target: {
                            files: files,
                        },
                    });
                }

                function handleResumeFiles(e) {
                    const files = [...e.target.files];
                    files.forEach((file) => {
                        const div = document.createElement("div");
                        div.className =
                            "resume-item d-flex justify-content-between align-items-center";
                        div.innerHTML = `
                                            <div>
                                                <i class="fas fa-file-pdf me-2"></i>
                                                ${file.name}
                                            </div>
                                            <button class="btn btn-sm btn-outline-danger" onclick="this.parentElement.remove()">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        `;
                        uploadedResumes.appendChild(div);
                        uploadedResumeCount.innerHTML = `No. of Uploaded resumes: ${uploadedResumes.children.length}`;
                    });
                }

                function handleJobFiles(e) {
                    const files = [...e.target.files];
                    if (files.length > 0) {
                        // Only show the last uploaded file
                        uploadedJobFile.innerHTML = "";
                        const file = files[0];
                        const div = document.createElement("div");
                        div.className =
                            "resume-item d-flex justify-content-between align-items-center";
                        div.innerHTML = `
                                    <div>
                                        <i class="fas fa-file-pdf me-2"></i>
                                        ${file.name}
                                    </div>
                                    <button class="btn btn-sm btn-outline-danger" onclick="this.parentElement.remove()">
                                        <i class="fas fa-times"></i>
                                    </button>
                                `;
                        uploadedJobFile.appendChild(div);
                    }
                }

                // Handle ranking button click
                rankingButton.addEventListener("click", function () {
                    if (!jobInput.files.length || !resumeInput.files.length) {
                        alert(
                            "Please upload resumes and a job description first."
                        );
                        return;
                    }

                    rankingButton.disabled = true;
                    document.getElementById("rankingResultsDiv").innerHTML = ""; // Clear placeholder

                    // Show the modal while waiting for response
                    let rankingModal = new bootstrap.Modal(
                        document.getElementById("rankingProgressModal")
                    );
                    rankingModal.show();
                    rankingButton.innerHTML = "Ranking...";

                    let formData = new FormData();
                    formData.append("job_requirement", jobInput.files[0]);

                    // Append all resumes to FormData
                    for (let file of resumeInput.files) {
                        formData.append("resumes", file);
                    }

                    // Send a single request after appending all resumes
                    fetch("/tfidf-with-jaccard-ranking", {
                        method: "POST",
                        body: formData,
                    })
                        .then((response) => {
                            return response.json();
                        })
                        .then((data) => {
                            if (data.success) {
                                console.log("API Response:", data);

                                let rankings = data.rankings || [];
                                let rankingResultsContainer =
                                    document.getElementById(
                                        "rankingResultsDiv"
                                    );

                                rankingResultsContainer.innerHTML = `
                                        <div class="card shadow-sm mb-3">
                                            <div class="card-body" style="overflow: auto; max-height: 500px; min-height: 500px;">
                                                ${
                                                    rankings.length > 0
                                                        ? rankings
                                                              .map(
                                                                  (
                                                                      ranking,
                                                                      index
                                                                  ) => `
                                                                    <div class="resume-match mb-3 border border-3 border-primary p-2">
                                                                        <div class="d-flex">
                                                                            <h6 class="mb-0">${ranking.resume_filename.slice(
                                                                                0,
                                                                                -4
                                                                            )}</h6>
                                                                        </div>
                                                                        <div class="progress">
                                                                            <div class="progress-bar" role="progressbar"
                                                                                style="width: ${ranking.score.toFixed(
                                                                                    2
                                                                                )}%"
                                                                                aria-valuemin="0" aria-valuemax="100">
                                                                                ${ranking.score.toFixed(
                                                                                    2
                                                                                )}%
                                                                            </div>
                                                                        </div>
                                                                    </div>`
                                                              )
                                                              .join("")
                                                        : "<p>No resumes found</p>"
                                                }
                                            </div>
                                        </div>
                                    `;
                                let rankingButton =
                                    document.getElementById("rankingButton");
                                rankingButton.disabled = true;
                                rankingButton.innerHTML =
                                    "Successfully Ranked Resumes!";
                                // Hide the modal once ranking is completed
                                let rankingModal = bootstrap.Modal.getInstance(
                                    document.getElementById(
                                        "rankingProgressModal"
                                    )
                                );
                                rankingModal.hide();
                            } else {
                                alert("Error: " + data.message);
                                let rankingButton =
                                    document.getElementById("rankingButton");
                                rankingButton.disabled = false;
                                rankingButton.innerHTML = "Rank Resumes";
                            }
                        })
                        .catch((error) => {
                            console.error("Error fetching data:", error);
                            let rankingButton =
                                document.getElementById("rankingButton");
                            rankingButton.disabled = false;
                            rankingButton.innerHTML = "Rank Resumes";
                        });
                });

                //analysis button
                document
                    .getElementById("analysisButton")
                    .addEventListener("click", function () {
                        // Get the modal element
                        let analysisModal = new bootstrap.Modal(
                            document.getElementById("analysisProgressModal")
                        );

                        // Show the modal
                        analysisModal.show();

                        // Send request to Flask route
                        fetch("/analyse-failed-resume", {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                            },
                        })
                            .then((response) => response.json())
                            .then((data) => {
                                if (data.success) {
                                    // Update modal content with results
                                    let analysisResultsContainer =
                                        document.getElementById(
                                            "analysisResultsDiv"
                                        );
                                    analysisResultsContainer.innerHTML = "";

                                    data.data.forEach((resume) => {
                                        let jobList = resume.top_jobs
                                            .map(
                                                (job) =>
                                                    `<li>${job.role}: ${job.score}</li>`
                                            )
                                            .join("");

                                        analysisResultsContainer.innerHTML += `
                                            <div class="resume-analysis">
                                                <h5>${resume.filename}</h5>
                                                <ul>${jobList}</ul>
                                                <p><strong>Analysis:</strong> ${resume.analysis}</p>
                                            </div>
                                            <hr>
                                        `;
                                    });
                                } else {
                                    document.getElementById(
                                        "analysisResults"
                                    ).innerHTML = `<p class="text-danger">${data.message}</p>`;
                                }
                            })
                            .catch((error) => {
                                console.error("Error:", error);
                                document.getElementById(
                                    "analysisResults"
                                ).innerHTML = `<p class="text-danger">Error analyzing resumes.</p>`;
                            });
                    });
                        .catch((error) => {
                            console.error("Error fetching data:", error);
                            let rankingButton =
                                document.getElementById("rankingButton");
                            rankingButton.disabled = false;
                            rankingButton.innerHTML = "Rank Resumes";
                        });
                });

                // Analyze Candidate Suitable Role Button
                document
                    .getElementById("analysisButton")
                    .addEventListener("click", function () {
                        if (
                            !jobInput.files.length ||
                            !resumeInput.files.length
                        ) {
                            alert(
                                "Please upload resumes and a job description first."
                            );
                            return;
                        }
                    });
            });
        </script>
    </body>
</html>

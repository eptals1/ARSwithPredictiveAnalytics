<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Automated Resume Screening with Predictive Analytics</title>
        <link href="/static/css/bootstrap-5.3.0.css" rel="stylesheet" />
        <link href="/static/css/font-awesome.css" rel="stylesheet" />
        <link href="/static/css/custom-style.css" rel="stylesheet" />
    </head>

    <body class="bg-light">
        <div class="container-fluid py-2">
            <!--h2 class="text-center"><h2-->

            <div class="row">
                <!-- Left Section - Upload and Requirements -->
                <div class="col-md-4 pe-md-2">
                    <div class="card shadow-sm">
                        <div class="card-body">
                            <h5 class="card-title mb-2">
                                <i class="fas fa-file-alt me-2"></i>
                                Upload Resumes
                            </h5>
                            <div
                                class="custom-file-upload p-2"
                                id="resumeUpload"
                            >
                                <i
                                    class="fas fa-cloud-upload-alt fa-2x mb-1"
                                ></i>
                                <p class="mb-0">Drag & Drop Resumes Here</p>
                                <p class="text-muted small">
                                    or click to browse (.pdf, .doc, .docx)
                                </p>
                                <input
                                    type="file"
                                    id="resumeInput"
                                    multiple
                                    accept=".pdf,.doc,.docx"
                                    class="d-none"
                                />
                            </div>
                            <div
                                id="uploadedResumeCount"
                                class="mb-2 text-muted"
                            >
                                No. of Resumes uploaded:
                            </div>
                            <div
                                class="resume-list p-2"
                                id="uploadedResumes"
                                style="
                                    height: 70px;
                                    border: 2px dashed#f7e8d2c8;
                                "
                            >
                                <span class="text-muted text-center">
                                    Uploaded resumes will appear here...
                                </span>
                            </div>

                            <!-- Job Requirements Section -->
                            <h5 class="card-title mb-2 mt-2">
                                <i class="fas fa-briefcase me-1"></i>
                                Upload Job Requirement
                            </h5>
                            <div
                                class="custom-file-upload"
                                id="jobRequirementUpload"
                            >
                                <i
                                    class="fas fa-cloud-upload-alt fa-2x mb-1"
                                ></i>
                                <p class="mb-0">
                                    Drag & Drop Job Requirement Here
                                </p>
                                <p class="text-muted small">
                                    or click to browse (.pdf, .doc, .docx)
                                </p>
                                <input
                                    type="file"
                                    id="jobInput"
                                    accept=".pdf,.doc,.docx"
                                    class="d-none"
                                />
                            </div>
                            <div
                                class="resume-list p-2"
                                id="uploadedJob"
                                style="
                                    height: 70px;
                                    border: 2px dashed#f7e8d2c8;
                                "
                            >
                                <span
                                    id="uploadedJobFile"
                                    class="text-muted text-center"
                                >
                                    Uploaded job requirement will appear here...
                                </span>
                            </div>

                            <div class="mt-2">
                                <button
                                    type="button"
                                    id="scoringButton"
                                    class="btn btn-primary w-100"
                                >
                                    <i class="fas fa-star-half-stroke me-2"></i>
                                    Get Resume Scores
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Middle Section - Results -->
                <div class="col-md-4 ps-md-2 mt-4 mt-md-0">
                    <div class="card shadow-sm" style="min-height: 580px">
                        <div class="card-body">
                            <h4 class="card-title mb-4">
                                <i class="fas fa-star-half-stroke me-2"></i>
                                Resume Scores
                            </h4>

                            <div id="analysisProgress" class="d-none">
                                <div class="progress mb-3">
                                    <div
                                        class="progress-bar progress-bar-striped progress-bar-animated"
                                        role="progressbar"
                                        style="width: 100%"
                                    ></div>
                                </div>
                                <p class="text-center text-muted">
                                    Scoring resumes...
                                </p>
                            </div>

                            <div id="scoringResults" style="height: 450px">
                                <!-- Results will be populated here -->
                                <div class="text-center text-muted py-5">
                                    <i
                                        class="fas fa-rectangle-list fa-3x mb-3"
                                    ></i>
                                    <p>
                                        Upload resumes and set job requirement
                                        to see scores of resumes
                                    </p>
                                </div>
                            </div>
                            <div
                                id="scoringResults"
                                style="
                                    display: none;
                                    overflow-y: scroll;
                                    max-height: 450px;
                                "
                            ></div>
                            <div class="mt-2">
                                <button
                                    type="button"
                                    id="analyzeButton"
                                    class="btn btn-success w-100"
                                >
                                    <i class="fas fa-chart-bar me-2"></i>
                                    Analyze Top Scoring Resume
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Section - Results -->
                <div class="col-md-4 ps-md-2 mt-4 mt-md-0">
                    <div class="card shadow-sm" style="min-height: 580px">
                        <div class="card-body">
                            <h4 class="card-title mb-4">
                                <i class="fas fa-chart-bar me-2"></i>Analytics
                                Result
                            </h4>

                            <div id="analysisProgress" class="d-none">
                                <div class="progress mb-3">
                                    <div
                                        class="progress-bar progress-bar-striped progress-bar-animated"
                                        role="progressbar"
                                        style="width: 100%"
                                    ></div>
                                </div>
                                <p class="text-center text-muted">
                                    Analyzing resumes...
                                </p>
                            </div>

                            <div id="analysisResults" style="min-height: 450px">
                                <!-- Results will be populated here -->
                                <div class="text-center text-muted py-5">
                                    <i
                                        class="fas fa-rectangle-list fa-3x mb-3"
                                    ></i>
                                    <p>
                                        Click 'Analyze Top Scoring Resume' to
                                        see suitable resumes based on the job
                                        requirement
                                    </p>
                                </div>
                            </div>
                            <div
                                id="analysisResults"
                                style="
                                    display: none;
                                    overflow-y: scroll;
                                    overflow-x: hidden;
                                    max-height: 474px;
                                "
                            ></div>
                            <div class="mt-2">
                                <button
                                    type="button"
                                    id="endAnalysisButton"
                                    class="btn btn-danger w-100"
                                >
                                    <i class="fas fa-chart-bar me-2"></i>
                                    End Analysis
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script src="/static/js/jquery-3.6.0.js"></script>
        <script src="/static/js/bootstrap-5.3.0.bundle.min.js"></script>
        <script>
            $(document).ready(function () {
                // Handle drag and drop for resumes
                const resumeDropZone = document.getElementById("resumeUpload");
                const resumeInput = document.getElementById("resumeInput");
                const uploadedResumes =
                    document.getElementById("uploadedResumes");
                const uploadedResumeCount = document.getElementById(
                    "uploadedResumeCount"
                );

                // Handle drag and drop for job requirements
                const jobDropZone = document.getElementById(
                    "jobRequirementUpload"
                );
                const jobInput = document.getElementById("jobInput");
                const uploadedJob = document.getElementById("uploadedJob");
                const uploadedJobFile =
                    document.getElementById("uploadedJobFile");

                const scoringButton = document.getElementById("scoringButton");
                const analyzeButton = document.getElementById("analyzeButton");
                const endAnalysisButton =
                    document.getElementById("endAnalysisButton");

                // Add drag and drop handlers for both zones
                [resumeDropZone, jobDropZone].forEach((dropZone) => {
                    ["dragenter", "dragover", "dragleave", "drop"].forEach(
                        (eventName) => {
                            dropZone.addEventListener(
                                eventName,
                                preventDefaults,
                                false
                            );
                        }
                    );

                    ["dragenter", "dragover"].forEach((eventName) => {
                        dropZone.addEventListener(
                            eventName,
                            () => highlight(dropZone),
                            false
                        );
                    });

                    ["dragleave", "drop"].forEach((eventName) => {
                        dropZone.addEventListener(
                            eventName,
                            () => unhighlight(dropZone),
                            false
                        );
                    });
                });

                function preventDefaults(e) {
                    e.preventDefault();
                    e.stopPropagation();
                }

                function highlight(element) {
                    element.classList.add("border-primary");
                }

                function unhighlight(element) {
                    element.classList.remove("border-primary");
                }

                // Resume upload handlers
                resumeDropZone.addEventListener(
                    "drop",
                    handleResumeDrop,
                    false
                );
                resumeDropZone.addEventListener("click", () =>
                    resumeInput.click()
                );
                resumeInput.addEventListener("change", handleResumeFiles);

                // Job requirements upload handlers
                jobDropZone.addEventListener("drop", handleJobDrop, false);
                jobDropZone.addEventListener("click", () => jobInput.click());
                jobInput.addEventListener("change", handleJobFiles);

                function handleResumeDrop(e) {
                    const dt = e.dataTransfer;
                    const files = dt.files;
                    handleResumeFiles({
                        target: {
                            files: files,
                        },
                    });
                }

                function handleJobDrop(e) {
                    const dt = e.dataTransfer;
                    const files = dt.files;
                    handleJobFiles({
                        target: {
                            files: files,
                        },
                    });
                }

                function handleResumeFiles(e) {
                    const files = [...e.target.files];
                    uploadedResumes.innerHTML = "";
                    uploadedResumeCount.innerHTML = `Uploaded resumes: 0`;
                    files.forEach((file) => {
                        const div = document.createElement("div");
                        div.className =
                            "resume-item d-flex justify-content-between align-items-center";
                        div.innerHTML = `
                        <div>
                            <i class="fas fa-file-pdf me-2"></i>
                            ${file.name}
                        </div>
                        <button class="btn btn-sm btn-outline-danger" onclick="this.parentElement.remove()">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                        uploadedResumes.appendChild(div);
                        uploadedResumeCount.innerHTML = `No. of Uploaded resumes: ${
                            uploadedResumes.children.length - 1
                        }`;
                    });
                }

                function handleJobFiles(e) {
                    const files = [...e.target.files];
                    if (files.length > 0) {
                        // Only show the last uploaded file
                        uploadedJob.innerHTML = "";
                        const file = files[0];
                        const div = document.createElement("div");
                        div.className =
                            "resume-item d-flex justify-content-between align-items-center";
                        div.innerHTML = `
                        <div>
                            <i class="fas fa-file-pdf me-2"></i>
                            ${file.name}
                        </div>
                        <button class="btn btn-sm btn-outline-danger" onclick="this.parentElement.remove()">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                        uploadedJob.appendChild(div);
                    }
                }

                // Handle scoring button click
                scoringButton.addEventListener("click", function () {
                    const resumeFiles = Array.from(resumeInput.files);
                    const jobFile = jobInput.files[0];

                    if (resumeFiles.length === 0) {
                        alert("Please upload at least one resume");
                        return;
                    }

                    if (!jobFile) {
                        alert("Please upload a job description");
                        return;
                    }

                    // Show loading state
                    scoringButton.disabled = true;
                    scoringButton.innerHTML =
                        '<i class="fas fa-spinner fa-spin me-2"></i>Scoring';
                    $("#scoringResults").hide();
                    $("#analysisProgress").removeClass("d-none");
                    $("#analyzeButton").hide();
                    $("#endAnalysisButton").show();
                    analyzeButton.disabled = true;

                    const formData = new FormData();

                    // Add resumes
                    resumeFiles.forEach((file, index) => {
                        formData.append(`resumes[]`, file);
                    });

                    // Add job description
                    formData.append("job_description", jobFile);

                    // Score Resume - send to server
                    fetch("/score-resume", {
                        method: "POST",
                        body: formData,
                        headers: {
                            "X-CSRFToken": "{{ csrf_token() }}",
                        },
                    })
                        .then((response) => {
                            if (!response.ok) {
                                throw new Error("Network response was not ok");
                            }
                            return response.json();
                        })
                        .then((data) => {
                            if (data.success) {
                                const results = data.data;
                                $("#scoringResults").hide();
                                analyzeButton.disabled = false;
                                // Update results section
                                const resultsDiv =
                                    document.getElementById("scoringResults");
                                $("#analyzeButton").show();
                                resultsDiv.innerHTML = `
                            <div class="card shadow-sm mb-3" style="overflow-y: scroll;
                                    max-height: 450px;">
                                <div class="card-body" style="overflow-y: scroll;
                                    max-height: 450px; min-height: 450px;">
                                     <!--h5 class="card-title">Resume Scores</h5-->
                                    ${results.resumes
                                        .map(
                                            (resume, index) => `
                                        <div class="resume-match mb-3">
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <h6 class="mb-0">${resume.resume_name}</h6>
                                                <span class="badge bg-primary">${resume.similarity}%</span>
                                            </div>
                                            <div class="progress">
                                                <div class="progress-bar" role="progressbar"
                                                     style="width: ${resume.similarity}%"
                                                     aria-valuenow="${resume.similarity}"
                                                     aria-valuemin="0"
                                                     aria-valuemax="100">
                                                </div>
                                            </div>
                                        </div>
                                    `
                                        )
                                        .join("")}
                                </div>
                            </div>
                        `;

                                // Show results section
                                resultsDiv.style.display = "block";
                            } else {
                                throw new Error(
                                    data.message || "Analysis failed"
                                );
                            }
                        })
                        .catch((error) => {
                            console.error("Error:", error);
                            alert("Error analyzing resumes: " + error.message);
                        })
                        .finally(() => {
                            // Reset button state
                            scoringButton.disabled = true;
                            scoringButton.innerHTML =
                                '<i class="fas fa-half-star-stroke me-2"></i>Analyze Resumes';
                            $("#analysisProgress").addClass("d-none");
                        });
                });
            });
        </script>
    </body>
</html>
